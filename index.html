<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñºÔ∏è Panoramic Mural Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 3px dashed #dee2e6;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 15px;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .load-btn {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            margin-left: 15px;
            transition: transform 0.2s ease;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .load-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .panorama-viewer {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: #f8f9fa;
            margin-bottom: 25px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: auto;
        }

        .placeholder {
            color: #6c757d;
            font-size: 1.1em;
            text-align: center;
        }

        .controls {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .controls h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #ff7b7b 0%, #ff9a9e 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 123, 123, 0.4);
        }

        .analysis-results {
            background: #fff;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            min-height: 100px;
        }

        .analysis-result {
            padding: 25px;
        }

        .analysis-result h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .coordinates {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.9em;
            color: #495057;
        }

        .analysis-content {
            line-height: 1.6;
            color: #495057;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.1em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #ffebee;
            color: #d32f2f;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #ffcdd2;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        .api-key-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-key-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .clear-key-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .control-group {
                flex-direction: column;
            }
            
            .file-input-label, .load-btn {
                display: block;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Panoramic Mural Analyzer</h1>
            <p>AI-powered analysis of murals using Claude Vision API</p>
        </div>

        <div class="main-content">
            <div class="api-key-section">
                <h4>üîë API Key Status</h4>
                <p>Your API key will be requested when you first use the app. It's stored locally in your browser.</p>
                <button class="clear-key-btn" onclick="clearApiKey()">Clear Stored Key</button>
            </div>

            <div class="upload-section">
                <h3>üì∏ Load Panoramic Image</h3>
                <p>Select a high-resolution panoramic image of your mural</p>
                <div class="file-input-wrapper">
                    <input type="file" id="panoramaInput" accept="image/*">
                    <label for="panoramaInput" class="file-input-label">Choose Panorama File</label>
                </div>
                <button class="load-btn" onclick="loadPanorama()">Load Panorama</button>
            </div>

            <div id="status" class="status">
                Ready to load panorama image...
            </div>

            <div id="panoramaViewer" class="panorama-viewer">
                <div class="placeholder">
                    üì∑ Panoramic image will appear here.<br>
                    Click and drag to select areas for analysis.
                </div>
            </div>

            <div id="controls" class="controls">
                <h3>üõ†Ô∏è Analysis Tools</h3>
                <div class="control-group">
                    <button class="control-btn" onclick="analyzeFullPanorama()">Analyze Full Mural</button>
                    <button class="control-btn" onclick="analyzePredefinedSections()">Analyze Sections</button>
                    <button class="control-btn" onclick="exportResults()">Export Results</button>
                </div>
            </div>

            <div id="analysisResults" class="analysis-results">
                <div class="placeholder" style="padding: 30px; text-align: center; color: #6c757d;">
                    üé® Analysis results will appear here after selecting an area
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Built with Claude API | Secure local storage | No data transmitted except to Anthropic</p>
        </div>
    </div>

    <script>
        // Configuration for API key management
        class Config {
            static getApiKey() {
                const storedKey = localStorage.getItem('anthropic_api_key');
                if (storedKey) {
                    return storedKey;
                }
                
                const key = prompt('Enter your Anthropic API key:');
                if (key && key.trim()) {
                    localStorage.setItem('anthropic_api_key', key.trim());
                    return key.trim();
                }
                
                throw new Error('API key required to use this application');
            }
            
            static clearStoredKey() {
                localStorage.removeItem('anthropic_api_key');
            }
        }

        // Main analyzer class
        class PanoramicMuralAnalyzer {
            constructor() {
                this.apiKey = Config.getApiKey();
                this.apiUrl = 'https://api.anthropic.com/v1/messages';
                this.panorama = null;
                this.canvas = null;
                this.ctx = null;
            }

            async loadPanorama(imageFile) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        this.panorama = img;
                        this.setupCanvas();
                        console.log(`Panorama loaded: ${img.naturalWidth}x${img.naturalHeight}`);
                        resolve(img);
                    };
                    img.onerror = reject;
                    img.src = URL.createObjectURL(imageFile);
                });
            }

            setupCanvas() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
            }

            async extractSection(x, y, width, height, scale = 1) {
                this.canvas.width = width * scale;
                this.canvas.height = height * scale;
                
                this.ctx.drawImage(
                    this.panorama,
                    x, y, width, height,
                    0, 0, width * scale, height * scale
                );
                
                return new Promise(resolve => {
                    this.canvas.toBlob(resolve, 'image/jpeg', 0.9);
                });
            }

            async blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            async analyzeSection(sectionBlob, prompt, sectionName = '') {
                try {
                    const base64Image = await this.blobToBase64(sectionBlob);
                    
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            messages: [
                                {
                                    role: 'user',
                                    content: [
                                        {
                                            type: 'image',
                                            source: {
                                                type: 'base64',
                                                media_type: 'image/jpeg',
                                                data: base64Image
                                            }
                                        },
                                        {
                                            type: 'text',
                                            text: prompt
                                        }
                                    ]
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.content[0].text;
                } catch (error) {
                    console.error(`Error analyzing section ${sectionName}:`, error);
                    throw error;
                }
            }

            createInteractiveViewer(containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const viewer = document.createElement('div');
                viewer.style.cssText = `
                    position: relative;
                    max-width: 100%;
                    overflow: auto;
                    border: 2px solid #ddd;
                    background: #f9f9f9;
                `;
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(this.panorama);
                img.style.cssText = `
                    max-width: 100%;
                    cursor: crosshair;
                    display: block;
                `;
                
                const selectionBox = document.createElement('div');
                selectionBox.style.cssText = `
                    position: absolute;
                    border: 2px dashed #ff0000;
                    background: rgba(255,0,0,0.1);
                    display: none;
                    pointer-events: none;
                `;
                
                let isSelecting = false;
                let startX, startY;
                
                img.addEventListener('mousedown', (e) => {
                    isSelecting = true;
                    const rect = img.getBoundingClientRect();
                    startX = e.clientX - rect.left;
                    startY = e.clientY - rect.top;
                    selectionBox.style.display = 'block';
                    selectionBox.style.left = startX + 'px';
                    selectionBox.style.top = startY + 'px';
                    selectionBox.style.width = '0px';
                    selectionBox.style.height = '0px';
                });
                
                img.addEventListener('mousemove', (e) => {
                    if (!isSelecting) return;
                    
                    const rect = img.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    const left = Math.min(startX, currentX);
                    const top = Math.min(startY, currentY);
                    const width = Math.abs(currentX - startX);
                    const height = Math.abs(currentY - startY);
                    
                    selectionBox.style.left = left + 'px';
                    selectionBox.style.top = top + 'px';
                    selectionBox.style.width = width + 'px';
                    selectionBox.style.height = height + 'px';
                });
                
                img.addEventListener('mouseup', async (e) => {
                    if (!isSelecting) return;
                    isSelecting = false;
                    
                    const rect = img.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    const scaleX = this.panorama.naturalWidth / rect.width;
                    const scaleY = this.panorama.naturalHeight / rect.height;
                    
                    const selection = {
                        x: Math.min(startX, currentX) * scaleX,
                        y: Math.min(startY, currentY) * scaleY,
                        width: Math.abs(currentX - startX) * scaleX,
                        height: Math.abs(currentY - startY) * scaleY
                    };
                    
                    if (selection.width > 10 && selection.height > 10) {
                        await this.analyzeSelectedArea(selection);
                    }
                    
                    selectionBox.style.display = 'none';
                });
                
                viewer.appendChild(img);
                viewer.appendChild(selectionBox);
                container.appendChild(viewer);
            }
            
            async analyzeSelectedArea(selection) {
                const resultsDiv = document.getElementById('analysisResults');
                resultsDiv.innerHTML = '<div class="loading">Analyzing selected area...</div>';
                
                try {
                    const sectionBlob = await this.extractSection(
                        selection.x, 
                        selection.y, 
                        selection.width, 
                        selection.height, 
                        2
                    );
                    
                    const prompt = `Analyze this selected section of a mural panorama in detail. Focus on:
                    - Artistic style and techniques used
                    - Cultural symbols and their meanings
                    - Historical context and significance
                    - Colors, composition, and visual elements
                    - Condition and any preservation concerns
                    - How this section relates to the broader mural narrative
                    
                    Provide a comprehensive analysis of what you observe.`;
                    
                    const analysis = await this.analyzeSection(sectionBlob, prompt, 'Selected Area');
                    
                    resultsDiv.innerHTML = `
                        <div class="analysis-result">
                            <h3>üé® Selected Area Analysis</h3>
                            <div class="coordinates">
                                <strong>Area:</strong> ${Math.round(selection.width)}√ó${Math.round(selection.height)} pixels | 
                                <strong>Position:</strong> (${Math.round(selection.x)}, ${Math.round(selection.y)})
                            </div>
                            <div class="analysis-content">${analysis.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                }
            }
        }

        // Global analyzer instance
        let analyzer = null;

        // Application functions
        async function initializeApp() {
            try {
                document.getElementById('status').textContent = 'Ready to analyze murals! Please load a panorama image.';
            } catch (error) {
                document.getElementById('status').textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function loadPanorama() {
            const fileInput = document.getElementById('panoramaInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a panorama image file');
                return;
            }
            
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'üì∏ Loading panorama...';
            
            try {
                analyzer = new PanoramicMuralAnalyzer();
                await analyzer.loadPanorama(file);
                analyzer.createInteractiveViewer('panoramaViewer');
                statusDiv.textContent = '‚úÖ Panorama loaded! Click and drag to select areas for analysis.';
                
                document.getElementById('controls').style.display = 'block';
            } catch (error) {
                statusDiv.textContent = `‚ùå Error loading panorama: ${error.message}`;
            }
        }

        function clearApiKey() {
            Config.clearStoredKey();
            location.reload();
        }

        function analyzeFullPanorama() {
            alert('Full panorama analysis feature coming soon!');
        }

        function analyzePredefinedSections() {
            alert('Predefined sections analysis feature coming soon!');
        }

        function exportResults() {
            alert('Export results feature coming soon!');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>